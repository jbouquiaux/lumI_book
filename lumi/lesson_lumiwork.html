
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Automatazing the ab-initio \(\Delta\)SCF procedure ; the LumiWork workflow &#8212; Lumi Book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=87e54e7c" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=3ee479438cf8b5e0d341"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"TeX": {"Macros": {"*": "{\\dagger}", "ra": "{\\rangle}", "la": "{\\langle}", "bm": ["{\\boldsymbol #1}", 1], "mcL": "{\\mathcal{L}}", "mcG": "{\\mathcal{G}}", "mcR": "{\\mathcal{R}}", "mcS": "{\\mathcal{S}}", "mcC": "{\\mathcal{C}}", "mcO": "{\\mathcal{O}}", "KS": "{\\text{KS}}", "eph": "{\\text{e-ph}}", "ee": "{\\epsilon}", "phph": "{\\text{ph-ph}}", "FM": "{\\text{FM}}", "DW": "{\\text{DW}}", "QP": "{\\text{QP}}", "BZ": "{\\text{BZ}}", "sign": "{\\text{sign}}", "xc": "{\\text{xc}}", "tchi": "{\\tilde\\chi}", "rr": "{\\bf r}", "RR": "{\\bf R}", "tt": "{\\bf t}", "GG": "{\\bf G}", "kk": "{\\bf k}", "qq": "{\\bf q}", "kq": "{\\kk + \\qq}", "qG": "{\\bf q + G}", "kG": "{\\bf k + G}", "kmq": "{\\kk - \\qq}", "kpq": "{\\kk + \\qq}", "kpG": "{\\kk + \\GG}", "qpG": "{\\qq + \\GG}", "nk": "{n \\kk}", "mk": "{, \\kk}", "nks": "{n \\kk\\sigma}", "mks": "{m \\kk\\sigma}", "enk": "{\\varepsilon_\\nk}", "emkq": "{\\varepsilon_{m\\kk+\\qq}}", "qnu": "{\\qq \\nu}", "wqnu": "{\\omega_{\\qnu}}", "vnk": "{\\mathbf{v}_{n\\kk}}", "vmkq": "{\\mathbf{v}_{m\\kk+\\qq}}", "vnka": "{\\mathrm{v}_{n\\kk,\\alpha}}", "vnkb": "{\\mathrm{v}_{n\\kk,\\beta}}", "ef": "{\\varepsilon_F}", "gkkp": "{g_{mn\\nu}(\\kk,\\qq)}", "gkq": "{g_{mn\\nu}(\\kk,\\qq)}", "Go": "{G_0}", "Wo": "{W_0}", "Ueff": "{U_{\\text{eff}}}", "tee": "{\\tilde{\\epsilon}}", "ww": "{\\omega}", "tww": "{\\tilde\\omega}", "dd": "{\\,\\text{d}}", "vxc": "{v_\\xc}", "Ri": "{\\mcR^{-1}}", "Rit": "{\\mcR^{-1\\tau}}", "Si": "{\\mcS^{-1}}}", "Sit": "{\\Si^\\tau}}", "PDER": ["{\\dfrac{\\partial #1}{\\partial #2}}", 2], "FDER": ["{\\dfrac{\\delta #1}{\\delta #2}}", 2], "tPsi": "{\\tilde\\Psi}", "tpsi": "{\\tilde\\psi}", "tPhi": "{\\tilde\\Phi}", "tphi": "{\\tilde\\phi}", "tprj": "{\\tilde p}"}}, "options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'lumi/lesson_lumiwork';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.2.0.min.js"></script>
    <link rel="icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Post-proccessing of a LumiWork, effective phonon mode model." href="lesson_post_process_1.html" />
    <link rel="prev" title="Theory" href="theory.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/lumi.png" class="logo__image only-light" alt="Lumi Book - Home"/>
    <script>document.write(`<img src="../_static/lumi.png" class="logo__image only-dark" alt="Lumi Book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Introduction
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Luminescence lineshape of point defects</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="theory.html">Theory</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Automatazing the ab-initio <span class="math notranslate nohighlight">\(\Delta\)</span>SCF procedure ; the LumiWork workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="lesson_post_process_1.html">Post-proccessing of a LumiWork, effective phonon mode model.</a></li>
<li class="toctree-l1"><a class="reference internal" href="lesson_multi_phonons.html">Post-proccessing of a LumiWork, multi phonon mode model.</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="lesson_lumi_examples.html">Examples</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="examples/example_1.html">Example 1</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">IFCs embedding</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../ifc_emb/theory.html">IFCs embedding, theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ifc_emb/lesson_ifc_emb_abinitio.html">ab-initio computations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ifc_emb/lesson_ifc_emb_postprocess.html">post-processing</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../ifc_emb/lesson_ifc_emb_examples.html">Examples</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../ifc_emb/examples/example_1.html">Example 1 : vacancy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ifc_emb/examples/example_2.html">Example 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ifc_emb/examples/example_3.html">Example 1</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/jbouquiaux/lumi_book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/jbouquiaux/lumi_book/edit/master/lumi_book/lumi/lesson_lumiwork.md" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/jbouquiaux/lumi_book/issues/new?title=Issue%20on%20page%20%2Flumi/lesson_lumiwork.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/lumi/lesson_lumiwork.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Automatazing the ab-initio \DeltaSCF procedure ; the LumiWork workflow</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recap">Recap</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-lumiwork">The LumiWork</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-a-lumiwork">Creating a LumiWork</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-a-lumiwork">Running a LumiWork</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#relaxations-only">Relaxations only?</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="automatazing-the-ab-initio-deltascf-procedure-the-lumiwork-workflow">
<h1>Automatazing the ab-initio <span class="math notranslate nohighlight">\(\Delta\)</span>SCF procedure ; the LumiWork workflow<a class="headerlink" href="#automatazing-the-ab-initio-deltascf-procedure-the-lumiwork-workflow" title="Link to this heading">#</a></h1>
<p>This tutorial aims at showing how to perform <span class="math notranslate nohighlight">\(\Delta\)</span>SCF constrained-occupations computations with abinit in an automatized way.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Before starting, it is recommended to first get familiar with the <a class="reference external" href="https://abinit.github.io/abipy_book/intro.html">abipy environement</a> and in particular with the working principle of <a class="reference external" href="https://abinit.github.io/abipy_book/flows.html">its workflows</a>.</p>
</div>
<p>The theory and equations associated to this tutorial can be found in the related <a class="reference internal" href="theory.html"><span class="std std-doc">theory section</span></a>, and references therein.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Most of the examples shown in these tutorials are biased towards a certain type of defect (Eu substitution), but the <span class="math notranslate nohighlight">\(\Delta\)</span>SCF constrained-occupations methodology is general and might be applied to numerous kind of defects.</p>
</div>
<section id="recap">
<h2>Recap<a class="headerlink" href="#recap" title="Link to this heading">#</a></h2>
<p>Our goal is to compute the photo-luminescent properties of an impurity embedded in a lattice. Here we will take the example of the red phosphor material Sr[Li<span class="math notranslate nohighlight">\(_2\)</span>Al<span class="math notranslate nohighlight">\(_2\)</span>O<span class="math notranslate nohighlight">\(_2\)</span>N<span class="math notranslate nohighlight">\(_2\)</span>]:Eu<span class="math notranslate nohighlight">\(^{2+}\)</span> (nicknamed SALON)</p>
<p>We need to compute the four states (energies and structures) highlighted in the figure below :</p>
<ol class="arabic simple">
<li><p>Relaxed ground state (A<span class="math notranslate nohighlight">\(_g\)</span>)</p></li>
<li><p>Unrelaxed excited state (A<span class="math notranslate nohighlight">\(_{e}^{*}\)</span>)</p></li>
<li><p>Relaxed excited state (A<span class="math notranslate nohighlight">\(_{e}\)</span>)</p></li>
<li><p>Unrelaxed ground state (A<span class="math notranslate nohighlight">\(_{g}^{*}\)</span>)</p></li>
</ol>
<a class="reference internal image-reference" href="../_images/CCM.png"><img alt="../_images/CCM.png" src="../_images/CCM.png" style="width: 600px;" /></a>
<p>This requires two relaxations (one in the ground and excited state) and four static scf computations (at each state). One could eventually add four nscf computations for the electronic band structures. These 6 (+4) computations are what is automatized in one “LumiWork”.</p>
<p>The exicted state configuration is computed following the
SCF-constrained occupation method, where the first unoccupied state of the ground state is force to be occupied in the excited state. On Abinit, the variable “occ” reads like :</p>
<ul class="simple">
<li><p>ground state  : occ … 1 1 1 0 0 0 0 …</p></li>
<li><p>excited state : occ … 1 1 0 1 0 0 0 …</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The example shown in this tutorial is designed to run in a few minutes on a laptop, meaning that the results are  unconverged (supercell size, different DFT parameters,…). More realistic examples of production runs can be found in the <a class="reference internal" href="examples/example_1.html"><span class="std std-doc">example section</span></a>.</p>
</div>
</section>
<section id="the-lumiwork">
<h2>The LumiWork<a class="headerlink" href="#the-lumiwork" title="Link to this heading">#</a></h2>
<p>The creation of one LumiWork is done with the class method from_scf_inputs() :</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">abipy.flowtk.lumi_works</span> <span class="kn">import</span> <span class="n">LumiWork</span>
<span class="n">help</span><span class="p">(</span><span class="n">LumiWork</span><span class="o">.</span><span class="n">from_scf_inputs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Help on method from_scf_inputs in module abipy.flowtk.lumi_works:

from_scf_inputs(gs_scf_inp, ex_scf_inp, relax_kwargs_gs, relax_kwargs_ex, ndivsm=0, nb_extra=10, tolwfr=1e-12, four_points=True, meta=None, manager=None) -&gt; &#39;LumiWork&#39; class method of abipy.flowtk.lumi_works.LumiWork
    Args:
        gs_scf_inp: |AbinitInput| representing a GS SCF run for the ground-state.
        ex_scf_inp: |AbinitInput| representing a GS SCF run for the excited-state.
        relax_kwargs_gs: Dictonary with input variables to be added to gs_scf_inp
            when generating input files for ground state structural relaxations.
        relax_kwargs_ex: Dictonary with input variables to be added to ex_scf_inp
            when generating input files for excited state structural relaxations.
        ndivsm: Activates the computation of band structure if different from zero.
            if &gt; 0, it&#39;s the number of divisions for the smallest segment of the path (Abinit variable).
            if &lt; 0, it&#39;s interpreted as the pymatgen `line_density` parameter in which the number of points
            in the segment is proportional to its length. Typical value: -20.
            This option is the recommended one if the k-path contains two high symmetry k-points that are very close
            as ndivsm &gt; 0 may produce a very large number of wavevectors.
        nb_extra: Number of extra bands added to the input nband when computing band structures (ndivsm != 0).
        tolwfr: Tolerance of the residuals used for the NSCF band structure calculations.
        four_points : if True, compute the two relaxations and the four points energies.
            If false, only the two relaxations.
        meta : dict corresponding to the metadata of a lumiwork (supercell size, dopant type,...)
        manager: |TaskManager| of the task. If None, the manager is initialized from the config file.
</pre></div>
</div>
</div>
</div>
<p>This class method is a container that receives mainly Abinit Input objects and dictionnaries of Abinit variables. The lumi_works.py script will then use these informations to do the following tasks:</p>
<ol class="arabic simple">
<li><p>Launch a first structural relaxation in the ground state (task t0), save the ground-state relaxed structure.</p></li>
<li><p>Use the previous structure as the starting point for a second structural relaxation in the excited state (task t1), save the excited-state relaxed  structure.</p></li>
<li><p>Launch the four static scf tasks simultaneously (tasks t2,t3,t4 and t5 in the order shown in the recap section)</p></li>
<li><p>Launch optionnaly the four NSCF tasks (tasks t6,t7,t8 and t9 in the same order)</p></li>
<li><p>Perform a first quick post-process and store the results in flow_deltaSCF/w0/outdata/Delta_SCF.json .</p></li>
</ol>
</section>
<section id="creating-a-lumiwork">
<h2>Creating a LumiWork<a class="headerlink" href="#creating-a-lumiwork" title="Link to this heading">#</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The complete workflow was ran separately, before building this jupyter book. You will find the worflow scripts and corresponding folder in the <a class="reference external" href="https://github.com/jbouquiaux/lumi_book/tree/main/lumi_book/lumi">github of this book</a></p>
</div>
<p>A LumiWork (or a serie of LumiWork’s) can be created with the run_deltaSCF.py script, as shown below :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">abipy.abilab</span> <span class="k">as</span> <span class="nn">abilab</span>
<span class="kn">import</span> <span class="nn">abipy.flowtk</span> <span class="k">as</span> <span class="nn">flowtk</span>
<span class="kn">import</span> <span class="nn">abipy.data</span> <span class="k">as</span> <span class="nn">abidata</span>
<span class="kn">from</span> <span class="nn">abipy.core</span> <span class="kn">import</span> <span class="n">structure</span>

<span class="k">def</span> <span class="nf">scf_inp</span><span class="p">(</span><span class="n">structure</span><span class="p">):</span>
    <span class="n">pseudodir</span><span class="o">=</span><span class="s1">&#39;pseudos&#39;</span>
    
    <span class="n">pseudos</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Eu.xml&#39;</span><span class="p">,</span>
               <span class="s1">&#39;Sr.xml&#39;</span><span class="p">,</span>
               <span class="s1">&#39;Al.xml&#39;</span><span class="p">,</span>
               <span class="s1">&#39;Li.xml&#39;</span><span class="p">,</span>
               <span class="s1">&#39;O.xml&#39;</span><span class="p">,</span>
               <span class="s1">&#39;N.xml&#39;</span><span class="p">)</span>
    <span class="n">gs_scf_inp</span> <span class="o">=</span> <span class="n">abilab</span><span class="o">.</span><span class="n">AbinitInput</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="o">=</span><span class="n">pseudos</span><span class="p">,</span><span class="n">pseudo_dir</span><span class="o">=</span><span class="n">pseudodir</span><span class="p">)</span>
    <span class="n">gs_scf_inp</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">ecut</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">pawecutdg</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                        <span class="n">chksymbreak</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">diemac</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">prtwf</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">nstep</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                        <span class="n">toldfe</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span>
                        <span class="n">chkprim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="p">)</span>

    <span class="c1"># Set DFT+U and spinat parameters according to chemical symbols.</span>
    <span class="n">symb2spinat</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Eu&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">]}</span>
    <span class="n">symb2luj</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Eu&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;lpawu&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;upawu&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s2">&quot;jpawu&quot;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">}}</span>

    <span class="n">gs_scf_inp</span><span class="o">.</span><span class="n">set_usepawu</span><span class="p">(</span><span class="n">usepawu</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">symb2luj</span><span class="o">=</span><span class="n">symb2luj</span><span class="p">)</span>
    <span class="n">gs_scf_inp</span><span class="o">.</span><span class="n">set_spinat_from_symbols</span><span class="p">(</span><span class="n">symb2spinat</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="n">n_val</span> <span class="o">=</span> <span class="n">gs_scf_inp</span><span class="o">.</span><span class="n">num_valence_electrons</span>
    <span class="n">n_cond</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>

    <span class="n">spin_up_gs</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="nb">int</span><span class="p">((</span><span class="n">n_val</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">*1 7*1 </span><span class="si">{</span><span class="n">n_cond</span><span class="si">}</span><span class="s2">*0&quot;</span>
    <span class="n">spin_up_ex</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="nb">int</span><span class="p">((</span><span class="n">n_val</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">*1 6*1 0 1 </span><span class="si">{</span><span class="n">n_cond</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">*0&quot;</span> 
    <span class="n">spin_dn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="nb">int</span><span class="p">((</span><span class="n">n_val</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">*1 7*0 </span><span class="si">{</span><span class="n">n_cond</span><span class="si">}</span><span class="s2">*0&quot;</span>

    <span class="n">nsppol</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">shiftk</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">ngkpt</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Build SCF input for the ground state configuration.</span>
    <span class="n">gs_scf_inp</span><span class="o">.</span><span class="n">set_kmesh_nband_and_occ</span><span class="p">(</span><span class="n">ngkpt</span><span class="p">,</span> <span class="n">shiftk</span><span class="p">,</span> <span class="n">nsppol</span><span class="p">,</span> <span class="p">[</span><span class="n">spin_up_gs</span><span class="p">,</span> <span class="n">spin_dn</span><span class="p">])</span>
    <span class="c1"># Build SCF input for the excited configuration.</span>
    <span class="n">exc_scf_inp</span> <span class="o">=</span> <span class="n">gs_scf_inp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
    <span class="n">exc_scf_inp</span><span class="o">.</span><span class="n">set_kmesh_nband_and_occ</span><span class="p">(</span><span class="n">ngkpt</span><span class="p">,</span> <span class="n">shiftk</span><span class="p">,</span> <span class="n">nsppol</span><span class="p">,</span> <span class="p">[</span><span class="n">spin_up_ex</span><span class="p">,</span> <span class="n">spin_dn</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">gs_scf_inp</span><span class="p">,</span><span class="n">exc_scf_inp</span>


<span class="k">def</span> <span class="nf">relax_kwargs</span><span class="p">():</span>

    <span class="c1"># Dictionary with input variables to be added for performing structural relaxations.</span>
    <span class="n">relax_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">ecutsm</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">toldff</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="c1"># TOO HIGH, just for testing purposes.</span>
        <span class="n">tolmxf</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="c1"># TOO HIGH, just for testing purposes.</span>
        <span class="n">ionmov</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">dilatmx</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span>  <span class="c1"># Keep this also for optcell 0 else relaxation goes bananas due to low ecut.</span>
        <span class="n">chkdilatmx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">relax_kwargs_gs</span><span class="o">=</span><span class="n">relax_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">relax_kwargs_gs</span><span class="p">[</span><span class="s1">&#39;optcell&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span> <span class="c1"># in the ground state, if allow relaxation of the cell (optcell 2)</span>

    <span class="n">relax_kwargs_ex</span><span class="o">=</span><span class="n">relax_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">relax_kwargs_ex</span><span class="p">[</span><span class="s1">&#39;optcell&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span> <span class="c1"># in the excited state, no relaxation of the cell</span>

    <span class="k">return</span> <span class="n">relax_kwargs_gs</span><span class="p">,</span> <span class="n">relax_kwargs_ex</span>


<span class="k">def</span> <span class="nf">build_flow</span><span class="p">(</span><span class="n">options</span><span class="p">):</span>

    <span class="c1"># Working directory (default is the name of the script with &#39;.py&#39; removed and &quot;run_&quot; replaced by &quot;flow_&quot;)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">workdir</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;run_&quot;</span><span class="p">,</span> <span class="s2">&quot;flow_&quot;</span><span class="p">)</span>

    <span class="n">flow</span> <span class="o">=</span> <span class="n">flowtk</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">manager</span><span class="p">)</span>

    <span class="c1">#Construct the structures</span>
    <span class="n">prim_structure</span><span class="o">=</span><span class="n">structure</span><span class="o">.</span><span class="n">Structure</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="s1">&#39;SALON_prim.cif&#39;</span><span class="p">)</span>
    <span class="n">structure_list</span><span class="o">=</span><span class="n">prim_structure</span><span class="o">.</span><span class="n">make_doped_supercells</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="s1">&#39;Sr&#39;</span><span class="p">,</span><span class="s1">&#39;Eu&#39;</span><span class="p">)</span>

    <span class="c1">####### Delta SCF part of the flow #######</span>
    
    <span class="kn">from</span> <span class="nn">abipy.flowtk.lumi_works</span> <span class="kn">import</span> <span class="n">LumiWork</span>
    
    <span class="k">for</span> <span class="n">stru</span> <span class="ow">in</span> <span class="n">structure_list</span><span class="p">:</span>
       <span class="n">gs_scf_inp</span><span class="p">,</span> <span class="n">exc_scf_inp</span> <span class="o">=</span> <span class="n">scf_inp</span><span class="p">(</span><span class="n">stru</span><span class="p">)</span>
       <span class="n">relax_kwargs_gs</span><span class="p">,</span> <span class="n">relax_kwargs_ex</span> <span class="o">=</span> <span class="n">relax_kwargs</span><span class="p">()</span>
       <span class="n">Lumi_work</span><span class="o">=</span><span class="n">LumiWork</span><span class="o">.</span><span class="n">from_scf_inputs</span><span class="p">(</span><span class="n">gs_scf_inp</span><span class="p">,</span> <span class="n">exc_scf_inp</span><span class="p">,</span> <span class="n">relax_kwargs_gs</span><span class="p">,</span> <span class="n">relax_kwargs_ex</span><span class="p">,</span><span class="n">ndivsm</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
       <span class="n">flow</span><span class="o">.</span><span class="n">register_work</span><span class="p">(</span><span class="n">Lumi_work</span><span class="p">)</span>
 
    <span class="k">return</span> <span class="n">flow</span>


<span class="nd">@flowtk</span><span class="o">.</span><span class="n">flow_main</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">options</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is our main function that will be invoked by the script.</span>
<span class="sd">    flow_main is a decorator implementing the command line interface.</span>
<span class="sd">    Command line args are stored in `options`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">build_flow</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>
</div>
<p>Let’s decompose this script.<br />
We first create the abinit input objects. This is achieved by the function <code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">scf_inp(structure):</span></code> that takes as argument a structure object. It returns abinit input objects for the ground and excited state. It is in this function that all the important abinit variables that are specific to the system under study are located. The tricky part is the automatic definition of the occupation number, this is achieved by :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="n">n_val</span> <span class="o">=</span> <span class="n">gs_scf_inp</span><span class="o">.</span><span class="n">num_valence_electrons</span>
    <span class="n">n_cond</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>  <span class="c1"># to be choosen by user</span>
     
    <span class="c1">#### SPECIFIC to Eu doped!!!! ######</span>
    <span class="n">spin_up_gs</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="nb">int</span><span class="p">((</span><span class="n">n_val</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">*1 7*1 </span><span class="si">{</span><span class="n">n_cond</span><span class="si">}</span><span class="s2">*0&quot;</span>  <span class="c1"># ground state occ for spin up</span>
    <span class="n">spin_up_ex</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="nb">int</span><span class="p">((</span><span class="n">n_val</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">*1 6*1 0 1 </span><span class="si">{</span><span class="n">n_cond</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">*0&quot;</span> <span class="c1"># exicted state occ for spin up</span>
    <span class="n">spin_dn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="nb">int</span><span class="p">((</span><span class="n">n_val</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">*1 7*0 </span><span class="si">{</span><span class="n">n_cond</span><span class="si">}</span><span class="s2">*0&quot;</span> <span class="c1"># ground/excited state occ for spin down</span>
    <span class="c1">####################################</span>

    <span class="n">nsppol</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">shiftk</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">ngkpt</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Build SCF input for the ground state configuration.</span>
    <span class="n">gs_scf_inp</span><span class="o">.</span><span class="n">set_kmesh_nband_and_occ</span><span class="p">(</span><span class="n">ngkpt</span><span class="p">,</span> <span class="n">shiftk</span><span class="p">,</span> <span class="n">nsppol</span><span class="p">,</span> <span class="p">[</span><span class="n">spin_up_gs</span><span class="p">,</span> <span class="n">spin_dn</span><span class="p">])</span>
    <span class="c1"># Build SCF input for the excited configuration.</span>
    <span class="n">exc_scf_inp</span> <span class="o">=</span> <span class="n">gs_scf_inp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
    <span class="n">exc_scf_inp</span><span class="o">.</span><span class="n">set_kmesh_nband_and_occ</span><span class="p">(</span><span class="n">ngkpt</span><span class="p">,</span> <span class="n">shiftk</span><span class="p">,</span> <span class="n">nsppol</span><span class="p">,</span> <span class="p">[</span><span class="n">spin_up_ex</span><span class="p">,</span> <span class="n">spin_dn</span><span class="p">])</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>These occupations are specific to Eu<span class="math notranslate nohighlight">\(^{2+}\)</span> doped system (seven 4f electrons)!</p>
</div>
<p>The relaxation parameters (that might be different between ground and excited state!) are given in the function <code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">relax_kwargs():</span></code>.
Finally, we are now able to create the workflow with :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">build_flow</span><span class="p">(</span><span class="n">options</span><span class="p">):</span>

    <span class="c1"># Working directory (default is the name of the script with &#39;.py&#39; removed and &quot;run_&quot; replaced by &quot;flow_&quot;)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">workdir</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;run_&quot;</span><span class="p">,</span> <span class="s2">&quot;flow_&quot;</span><span class="p">)</span>

    <span class="n">flow</span> <span class="o">=</span> <span class="n">flowtk</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">manager</span><span class="p">)</span>

    <span class="c1">#Construct the structures</span>
    <span class="n">prim_structure</span><span class="o">=</span><span class="n">structure</span><span class="o">.</span><span class="n">Structure</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="s1">&#39;SALON_prim.cif&#39;</span><span class="p">)</span>
    <span class="n">structure_list</span><span class="o">=</span><span class="n">prim_structure</span><span class="o">.</span><span class="n">make_doped_supercells</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="s1">&#39;Sr&#39;</span><span class="p">,</span><span class="s1">&#39;Eu&#39;</span><span class="p">)</span>

    <span class="c1">####### Delta SCF part of the flow #######</span>
    
    <span class="kn">from</span> <span class="nn">abipy.flowtk.lumi_works</span> <span class="kn">import</span> <span class="n">LumiWork</span>
    
    <span class="k">for</span> <span class="n">stru</span> <span class="ow">in</span> <span class="n">structure_list</span><span class="p">:</span> <span class="c1">## loop through all the non-equivalent sites available for Eu. </span>
       <span class="n">gs_scf_inp</span><span class="p">,</span> <span class="n">exc_scf_inp</span> <span class="o">=</span> <span class="n">scf_inp</span><span class="p">(</span><span class="n">stru</span><span class="p">)</span>
       <span class="n">relax_kwargs_gs</span><span class="p">,</span> <span class="n">relax_kwargs_ex</span> <span class="o">=</span> <span class="n">relax_kwargs</span><span class="p">()</span>
       <span class="n">Lumi_work</span><span class="o">=</span><span class="n">LumiWork</span><span class="o">.</span><span class="n">from_scf_inputs</span><span class="p">(</span><span class="n">gs_scf_inp</span><span class="p">,</span> <span class="n">exc_scf_inp</span><span class="p">,</span> <span class="n">relax_kwargs_gs</span><span class="p">,</span> <span class="n">relax_kwargs_ex</span><span class="p">,</span><span class="n">ndivsm</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
       <span class="n">flow</span><span class="o">.</span><span class="n">register_work</span><span class="p">(</span><span class="n">Lumi_work</span><span class="p">)</span>
 
    <span class="k">return</span> <span class="n">flow</span> 
</pre></div>
</div>
<p>Where we have use the convenient <code class="docutils literal notranslate"><span class="pre">make_doped_supercells()</span></code> method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">abipy.core.structure</span> <span class="kn">import</span> <span class="n">Structure</span>
<span class="n">help</span><span class="p">(</span><span class="n">Structure</span><span class="o">.</span><span class="n">make_doped_supercells</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Help on function make_doped_supercells in module abipy.core.structure:

make_doped_supercells(self, scaling_matrix, replaced_atom, dopant_atom)
    Returns a list doped supercell structures, one for each non-equivalent site of the replaced atom.
    Args:
        scaling_matrix: A scaling matrix for transforming the lattice vectors.
            Has to be all integers. Several options are possible:
            a. A full 3x3 scaling matrix defining the linear combination of the old lattice vectors.
                E.g., [[2,1,0],[0,3,0],[0,0,1]] generates a new structure with lattice vectors
                a&#39; = 2a + b, b&#39; = 3b, c&#39; = c
                where a, b, and c are the lattice vectors of the original structure.
            b. A sequence of three scaling factors. e.g., [2, 1, 1]
               specifies that the supercell should have dimensions 2a x b x c.
            c. A number, which simply scales all lattice vectors by the same factor.
        replaced atom : Symbol of the atom to be replaced (ex: &#39;Sr&#39;)
        dopant_atom : Symbol of the dopant_atom (ex: &#39;Eu&#39;)
</pre></div>
</div>
</div>
</div>
</section>
<section id="running-a-lumiwork">
<h2>Running a LumiWork<a class="headerlink" href="#running-a-lumiwork" title="Link to this heading">#</a></h2>
<p>Let us run see what running the code in practice looks like. In your terminal, create the worfklow with</p>
<div class="highlight-command notranslate"><div class="highlight"><pre><span></span>python run_deltaSCF.py
</pre></div>
</div>
<p>A new /flow_deltaSCF folder should be created.
We observe that at this time, only one taks is created in  /flow_deltaSCF/w0/t0, the first ground state relaxation. This is normal since the rest of the workflow will be created at run-time, when the ground state relaxed structure will be extracted.
We launch the flow with the command :</p>
<div class="highlight-command notranslate"><div class="highlight"><pre><span></span>nohup abirun.py flow_deltaSCF scheduler &gt; log 2&gt; err &amp;
</pre></div>
</div>
<p>After completion, you can verifiy the status of the flow with</p>
<div class="highlight-command notranslate"><div class="highlight"><pre><span></span>abirun.py flow_deltaSCF status
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/workflow.png"><img alt="../_images/workflow.png" src="../_images/workflow.png" style="width: 600px;" /></a>
<p>A first quick post-proccessing of the results (following a 1D-CCM, see <a class="reference external" href="https://docs.python.org/3.9/glossary.html#term-1" title="Python 3.9"><span class="xref myst">next section</span></a>) can be found in /flow_deltaSCF/w0/Delta_SCF.json file.</p>
</section>
<section id="relaxations-only">
<h2>Relaxations only?<a class="headerlink" href="#relaxations-only" title="Link to this heading">#</a></h2>
<p>In some cases, it might be interesting to perform the two relaxation only, or the 4 static computations only. This flexibility is allowed thanks to the <code class="docutils literal notranslate"><span class="pre">LumiWork_relaxations()</span></code> class</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">abipy.flowtk.lumi_works</span> <span class="kn">import</span> <span class="n">LumiWork_relaxations</span>
<span class="nb">print</span><span class="p">(</span><span class="n">LumiWork_relaxations</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
<span class="n">help</span><span class="p">(</span><span class="n">LumiWork_relaxations</span><span class="o">.</span><span class="n">from_scf_inputs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>    This Work implements the ground and excited state relaxations only.

    The relaxations run simultaneously. No task creation at run-time. 
    
Help on method from_scf_inputs in module abipy.flowtk.lumi_works:

from_scf_inputs(gs_scf_inp, ex_scf_inp, relax_kwargs_gs, relax_kwargs_ex, meta=None, manager=None) class method of abipy.flowtk.lumi_works.LumiWork_relaxations
    Args:
        gs_scf_inp: |AbinitInput| representing a GS SCF run for the ground-state.
        ex_scf_inp: |AbinitInput| representing a GS SCF run for the excited-state.
        relax_kwargs_gs: Dictonary with input variables to be added to gs_scf_inp
            when generating input files for ground state structural relaxations.
        relax_kwargs_ex: Dictonary with input variables to be added to ex_scf_inp
            when generating input files for excited state structural relaxations.
        meta : dict corresponding to the metadata of a lumiwork (supercell size, dopant type,...)
        manager: |TaskManager| of the task. If None, the manager is initialized from the config file.
</pre></div>
</div>
</div>
</div>
<p>and with the <code class="docutils literal notranslate"><span class="pre">LumiWorkFromRelax</span></code> class</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">abipy.flowtk.lumi_works</span> <span class="kn">import</span> <span class="n">LumiWorkFromRelax</span>
<span class="nb">print</span><span class="p">(</span><span class="n">LumiWorkFromRelax</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
<span class="n">help</span><span class="p">(</span><span class="n">LumiWorkFromRelax</span><span class="o">.</span><span class="n">from_scf_inputs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>    Same as LumiWork, without the relaxations. Typically used after a LumiWork_relaxations work.
    The two relaxed structures (in ground and excited state) are given as input. No creation at run-time

    
Help on method from_scf_inputs in module abipy.flowtk.lumi_works:

from_scf_inputs(gs_scf_inp, ex_scf_inp, gs_structure, ex_structure, ndivsm=0, nb_extra=10, tolwfr=1e-12, meta=None, manager=None) class method of abipy.flowtk.lumi_works.LumiWorkFromRelax
    Args:
        gs_scf_inp: |AbinitInput| representing a GS SCF run for the ground-state.
        exc_scf_inp: |AbinitInput| representing a GS SCF run for the excited-state.
        gs_structure: object representing the relaxed ground state structure
        ex_structure: object representing the excited ground state structure
        ndivsm: Activates the computation of band structure if different from zero.
            if &gt; 0, it&#39;s the number of divisions for the smallest segment of the path (Abinit variable).
            if &lt; 0, it&#39;s interpreted as the pymatgen `line_density` parameter in which the number of points
            in the segment is proportional to its length. Typical value: -20.
            This option is the recommended one if the k-path contains two high symmetry k-points that are very close
            as ndivsm &gt; 0 may produce a very large number of wavevectors.
        nb_extra: Number of extra bands added to the input nband when computing band structures (ndivsm != 0).
        tolwfr: Tolerance of the residuals used for the NSCF band structure calculations.
        manager: |TaskManager| of the task. If None, the manager is initialized from the config file.
</pre></div>
</div>
</div>
</div>
<p>Running only one computation is also feasible by changing the end of the run_DeltaSCF.py script. For example, if you only need the ground state relaxation, you might use <code class="docutils literal notranslate"><span class="pre">LumiWork_relaxations.from_scf_inputs()</span></code> and register only the first task :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Lumi_work</span><span class="o">=</span><span class="n">LumiWork_relaxations</span><span class="o">.</span><span class="n">from_scf_inputs</span><span class="p">(</span><span class="n">gs_scf_inp</span><span class="p">,</span> <span class="n">exc_scf_inp</span><span class="p">,</span> <span class="n">relax_kwargs_gs</span><span class="p">,</span> <span class="n">relax_kwargs_ex</span><span class="p">,</span><span class="n">ndivsm</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">flow</span><span class="o">.</span><span class="n">register_task</span><span class="p">(</span><span class="n">Lumi_work</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># notice the register_task and not register_work</span>
</pre></div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./lumi"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="theory.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Theory</p>
      </div>
    </a>
    <a class="right-next"
       href="lesson_post_process_1.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Post-proccessing of a LumiWork, effective phonon mode model.</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recap">Recap</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-lumiwork">The LumiWork</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-a-lumiwork">Creating a LumiWork</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-a-lumiwork">Running a LumiWork</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#relaxations-only">Relaxations only?</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By J. Bouquiaux and the AbiPy group
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>